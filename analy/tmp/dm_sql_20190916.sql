-- 头条未加密部分各模块统计
select '头条未加密部分各模块统计' model,
       '日期' pt_days,
       'uv_头条-搜索' uv1,
       'uv_头条-小程序' uv2,
       'uv_头条-短视频category' uv3,
       'uv_头条-短视频action' uv4,
       'uv_头条-短视频合并ca' uv5,
       'uv_头条-短视频openapi' uv6,
       'uv_头条问答s' uv7,
       'uv_头条-小视频合并' uv8,
       'uv_头条点击日活caaa' uv9,
       'uv_头条-小mcs' uv10,
       'uv_头条-microapp' uv11,
       'uv_头条-我的页面' uv12,
       'uv_主TL视频点击' uv13,
       'uv_微头条' uv14,
       'uv_category=hotsoon_video' uv15,
       'uv_category=hotsoon_video_detail_draw' uv16,
       'uv_category=live' uv17,
       'uv_videolive' uv18,
       'uv_get_ugc_video' uv19,
       'pv_头条-搜索' pv1,
       'pv_头条-小程序' pv2,
       'pv_头条-短视频category' pv3,
       'pv_头条-短视频action' pv4,
       'pv_头条-短视频合并ca' pv5,
       'pv_头条-短视频openapi' pv6,
       'pv_头条问答s' pv7,
       'pv_头条-小视频合并' pv8,
       'pv_头条点击日活caaa' pv9,
       'pv_头条-小mcs' pv10,
       'pv_头条-microapp' pv11,
       'pv_头条-我的页面' pv12,
       'pv_主TL视频点击' pv13,
       'pv_微头条' pv14,
       'pv_category=hotsoon_video' pv15,
       'pv_category=hotsoon_video_detail_draw' pv16,
       'pv_category=live' pv17,
       'pv_videolive' pv18,
       'pv_get_ugc_video' pv19
       ;
select '头条未加密部分各模块统计' model,
        pt_days,
        count(distinct(case when tag1=1 then device_number else null end)) uv1,
        count(distinct(case when tag2=1 then device_number else null end)) uv2,
        count(distinct(case when tag3=1 then device_number else null end)) uv3,
        count(distinct(case when tag4=1 then device_number else null end)) uv4,
        count(distinct(case when tag5=1 then device_number else null end)) uv5,
        count(distinct(case when tag6=1 then device_number else null end)) uv6,
        count(distinct(case when tag7=1 then device_number else null end)) uv7,
        count(distinct(case when tag8=1 then device_number else null end)) uv8,
        count(distinct(case when tag9=1 then device_number else null end)) uv9,
        count(distinct(case when tag10=1 then device_number else null end)) uv10,
        count(distinct(case when tag11=1 then device_number else null end)) uv11,
        count(distinct(case when tag12=1 then device_number else null end)) uv12,
        count(distinct(case when tag13=1 then device_number else null end)) uv13,
        count(distinct(case when tag14=1 then device_number else null end)) uv14,
        count(distinct(case when tag15=1 then device_number else null end)) uv15,
        count(distinct(case when tag16=1 then device_number else null end)) uv16,
        count(distinct(case when tag17=1 then device_number else null end)) uv17,
        count(distinct(case when tag18=1 then device_number else null end)) uv18,
        count(distinct(case when tag19=1 then device_number else null end)) uv19,
        sum(case when tag1=1 then 1 else 0 end) pv1,
        sum(case when tag2=1 then 1 else 0 end) pv2,
        sum(case when tag3=1 then 1 else 0 end) pv3,
        sum(case when tag4=1 then 1 else 0 end) pv4,
        sum(case when tag5=1 then 1 else 0 end) pv5,
        sum(case when tag6=1 then 1 else 0 end) pv6,
        sum(case when tag7=1 then 1 else 0 end) pv7,
        sum(case when tag8=1 then 1 else 0 end) pv8,
        sum(case when tag9=1 then 1 else 0 end) pv9,
        sum(case when tag10=1 then 1 else 0 end) pv10,
        sum(case when tag11=1 then 1 else 0 end) pv11,
        sum(case when tag12=1 then 1 else 0 end) pv12,
        sum(case when tag13=1 then 1 else 0 end) pv13,
        sum(case when tag14=1 then 1 else 0 end) pv14,
        sum(case when tag15=1 then 1 else 0 end) pv15,
        sum(case when tag16=1 then 1 else 0 end) pv16,
        sum(case when tag17=1 then 1 else 0 end) pv17,
        sum(case when tag18=1 then 1 else 0 end) pv18,
        sum(case when tag19=1 then 1 else 0 end) pv19
   from
      (select pt_days,
            device_number,
            hh,
            max(case when instr(urltag,'keyword')>0 then 1 else 0 end) tag1,
            max(case when url_host='developer.toutiao.com'  and actiontag>2 then 1 else 0 end) tag2,
            max(case when instr(urltag,'category=video')>0 then 1 else 0 end) tag3,
            max(case when instr(urltag,'action=GetPlayInfo')>0 then 1 else 0 end) tag4,
            max(case when instr(urltag,'category=video')>0 or instr(urltag,'action=GetPlayInfo')>0  then 1 else 0 end) tag5,
            max(case when instr(urltag,'video/openapi')>0 then 1 else 0 end) tag6,
            max(case when instr(urltag,'answer/detail')>0 then 1 else 0 end) tag7,
            max(case when instr(urltag,'category=hotsoon_video')>0 or instr(urltag,'category=hotsoon_video_detail_draw')>0 or instr(urltag,'category=live')>0 or instr(urltag,'videolive')>0  or instr(urltag,'get_ugc_video')>0  then 1 else 0 end) tag8,
            max(case when instr(urltag,'category=video')>0  or instr(urltag,'action=GetPlayInfo')>0 or instr(urltag,'article/information')>0 or instr(urltag,'answer/detail')>0 then 1 else 0 end) tag9,
            max(case when url_host='mcs.snssdk.com' then 1 else 0 end) tag10,
            max(case when url_host='microapp.bytedance.com' then 1 else 0 end) tag11,
            max(case when instr(urltag,'user/profile')>0 then 1 else 0 end) tag12,
            max(case when (instr(urltag,'video/play')>0 or instr(urltag,'video/app')>0) and instr(urltag,'from_category=__all__')>0 then 1 else 0 end) tag13,
            max(case when instr(urltag,'ugc/repost/')>0 then 1 else 0 end) tag14,
            max(case when instr(urltag,'category=hotsoon_video')>0 then 1 else 0 end) tag15,
            max(case when instr(urltag,'category=hotsoon_video_detail_draw')>0 then 1 else 0 end) tag16,
            max(case when instr(urltag,'category=live')>0 then 1 else 0 end) tag17,
            max(case when instr(urltag,'videolive')>0 then 1 else 0 end) tag18,
            max(case when instr(urltag,'get_ugc_video')>0 then 1 else 0 end) tag19
          from  user_action_tag_d
          where pt_days>='20190801' and pt_days<='20190831'
            and ((url_host like '%.snssdk.com' and instr(urltag,'app_name=news_article')>0)
                  or url_host in ('developer.toutiao.com','microapp.bytedance.com'))
        group by pt_days,
                 device_number,
                 hh) a
      group by pt_days;
